<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadAble - 10 Step Lab</title>
    <style>
        :root { 
            --navy: #003067; 
            --brown: #431f0a; 
            --cream: #f9f4e8; 
        }

        @font-face { 
            font-family: 'OpenDyslexic'; 
            src: url('OpenDyslexic-Regular.otf'); 
        }

        body {
            background-color: var(--cream);
            font-family: 'OpenDyslexic', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            min-height: 100vh;
        }

        .lab-card {
            background: white;
            padding: 30px;
            border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            max-width: 600px; width: 100%; text-align: center;
        }

        .progress-bar { 
            width: 100%; height: 10px; background: #eee; 
            border-radius: 10px; margin-bottom: 20px; overflow: hidden; 
        }

        #progress-fill { 
            width: 0%; height: 100%; background: var(--navy); transition: 0.4s; 
        }

        .q-text { color: var(--navy); font-size: 1.8rem; margin-bottom: 15px; min-height: 60px; }
        
        .stage {
            background: #fafafa; border: 3px dashed #ddd; border-radius: 25px;
            margin: 20px auto; min-height: 250px; display: flex;
            align-items: center; justify-content: center; position: relative;
        }

        #visual-box { font-size: 5rem; color: var(--navy); }
        canvas { border-radius: 25px; touch-action: none; cursor: crosshair; display: none; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn {
            padding: 18px; font-size: 1.4rem; border: 3.5px solid var(--navy);
            background: white; border-radius: 15px; cursor: pointer; font-family: 'OpenDyslexic';
        }
        .btn:hover { background: var(--navy); color: white; }
        .clear-btn { border-color: var(--brown); color: var(--brown); display: none; margin-top: 10px;}
    </style>
</head>
<body>

<div class="lab-card">
    <div class="progress-bar"><div id="progress-fill"></div></div>
    <h2 id="q-text" class="q-text">Ready to start for an Assessement?</h2>
    
    <div class="stage" id="stage">
        <div id="visual-box">ðŸŒŸ</div>
        <canvas id="drawArea" width="500" height="250"></canvas>
    </div>

    <div class="btn-grid" id="controls">
        <button class="btn" style="grid-column: span 2;" onclick="startLab()">Let's Go!</button>
    </div>
    <button class="btn clear-btn" id="clear-btn" onclick="clearCanvas()">Clear Drawing</button>
</div>

<script>
    const questions = [
        { q: "Which one is 'b'?", v: "b | d", opts: ["Left", "Right"], type: "visual" },
        { q: "Draw the letter 'b'", draw: true, type: "visual" },
        { q: "Do the words shake?", v: "Hello", opts: ["No", "Yes"], type: "tracking" },
        { q: "Draw the letter 'd'", draw: true, type: "visual" },
        { q: "Listen: Which word is it?", audio: "Ball", opts: ["Ball", "Doll"], type: "phonetic" },
        { q: "Is it hard to stay on line?", v: "The cat sat.", opts: ["Easy", "Hard"], type: "tracking" },
        { q: "Draw the letter 'p'", draw: true, type: "visual" },
        { q: "Which one is '6'?", v: "6 | 9", opts: ["Left", "Right"], type: "visual" },
        { q: "Listen: Which word is it?", audio: "Apple", opts: ["Apple", "Purple"], type: "phonetic" },
        { q: "Draw a straight line", draw: true, type: "tracking" }
    ];

    let current = 0;
    let struggles = { visual: 0, phonetic: 0, tracking: 0 };

    const canvas = document.getElementById('drawArea');
    const ctx = canvas.getContext('2d');
    let painting = false;

    function startLab() { loadStep(); }

    function loadStep() {
        const q = questions[current];
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('progress-fill').style.width = ((current + 1) * 10) + "%";
        
        // --- REMOVED AUTOMATIC SPEECH HERE ---
        // (No more reading the question out loud automatically)

        const visualBox = document.getElementById('visual-box');
        const controls = document.getElementById('controls');
        const clearBtn = document.getElementById('clear-btn');

        visualBox.style.display = "block";
        canvas.style.display = "none";
        clearBtn.style.display = "none";
        controls.innerHTML = "";

        if (q.draw) {
            visualBox.style.display = "none";
            canvas.style.display = "block";
            clearBtn.style.display = "inline-block";
            controls.innerHTML = `<button class="btn" style="grid-column: span 2;" onclick="next('done', '${q.type}')">Done Drawing</button>`;
            clearCanvas();
        } else if (q.audio) {
            // Manual sound icon still available for Phonetic questions
            visualBox.innerHTML = `<span style="font-size:4rem; cursor:pointer;" onclick="say('${q.audio}')">ðŸ”Š</span>`;
            // Removed automatic say(q.audio) call here as well
            q.opts.forEach(opt => {
                controls.innerHTML += `<button class="btn" onclick="next('${opt}', '${q.type}', '${q.audio}')">${opt}</button>`;
            });
        } else {
            visualBox.innerText = q.v;
            q.opts.forEach(opt => {
                controls.innerHTML += `<button class="btn" onclick="next('${opt}', '${q.type}')">${opt}</button>`;
            });
        }
    }

    function say(word) {
        window.speechSynthesis.cancel(); // Stop any current sound before starting new one
        const m = new SpeechSynthesisUtterance(word);
        m.rate = 0.6;
        window.speechSynthesis.speak(m);
    }

    function next(choice, type, correctAudio) {
        if (type === "visual" && (choice === "Right" || choice === "d" || choice === "9")) struggles.visual++;
        if (type === "phonetic" && choice !== correctAudio) struggles.phonetic++;
        if (type === "tracking" && (choice === "Yes" || choice === "Hard")) struggles.tracking++;

        current++;
        if (current < questions.length) {
            loadStep();
        } else {
            showResult();
        }
    }

    function showResult() {
        let recommendedMode = "visual";
        let maxStruggles = struggles.visual;

        if (struggles.phonetic > maxStruggles) {
            maxStruggles = struggles.phonetic;
            recommendedMode = "phonetic";
        }
        if (struggles.tracking > maxStruggles) {
            maxStruggles = struggles.tracking;
            recommendedMode = "tracking";
        }

        localStorage.setItem('dyslexiaType', JSON.stringify({
            recommendation: recommendedMode,
            counts: struggles
        }));

        document.getElementById('q-text').innerText = "All Done! âœ¨";
        document.getElementById('stage').innerHTML = `<p style='font-size:1.5rem; padding:20px; line-height:1.6;'>Great job! We've prepared your specialized <b>${recommendedMode.toUpperCase()}</b> space.</p>`;
        document.getElementById('controls').innerHTML = `<button class="btn" style="grid-column: span 2;" onclick="location.href='lab.html'">Go to My Lab</button>`;
        document.getElementById('clear-btn').style.display = "none";
    }

    function startPaint(e) { painting = true; ctx.beginPath(); paint(e); }
    function endPaint() { painting = false; }
    function paint(e) {
        if (!painting) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left;
        const y = (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top;
        ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.strokeStyle = '#003067';
        ctx.lineTo(x, y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x, y);
    }

    canvas.addEventListener('mousedown', startPaint);
    canvas.addEventListener('mousemove', paint);
    canvas.addEventListener('mouseup', endPaint);
    canvas.addEventListener('touchstart', startPaint);
    canvas.addEventListener('touchmove', paint);
    canvas.addEventListener('touchend', endPaint);
    
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); }
</script>
</body>
</html>